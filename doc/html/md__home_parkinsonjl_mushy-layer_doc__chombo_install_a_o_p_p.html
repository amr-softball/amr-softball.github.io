<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Mushy Layer: Guide to installing Chombo on AOPP servers</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Mushy Layer
   &#160;<span id="projectnumber">1.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Guide to installing Chombo on AOPP servers </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><ol type="1">
<li>Login into the server e.g. <code>$ ssh -X gyre1</code></li>
<li><b>10 minutes</b>. Get the latest chombo version. Whilst the <a href="https://anag-repo.lbl.gov/chombo-3.2/access.html">Chombo website</a> will tell you to get the repository located at <code><a href="https://anag-repo.lbl.gov/svn/Chombo/release/3.2">https://anag-repo.lbl.gov/svn/Chombo/release/3.2</a></code>, you should actually get the code from 'Chombo Trunk' which is like a development branch and contains code needed for the Mushy Layer program. This is located at <code><a href="https://anag-repo.lbl.gov/svn/Chombo/trunk/">https://anag-repo.lbl.gov/svn/Chombo/trunk/</a></code>, so, using <code>svn</code>, you should run something like (replace 'jparkinson' with your username) <div class="fragment"><div class="line">$ svn --username jparkinson co https://anag-repo.lbl.gov/svn/Chombo/trunk/ ~/Chombo</div></div><!-- fragment --></li>
<li>Copy the makefile from <code>/mushy-layer/doc/Make.defs.AOPP</code> (in the same directory as this readme) to <code>Chombo/lib/mk/Make.defs.local</code> e.g. <div class="fragment"><div class="line">$ cp ~/mushy-layer/doc/Make.defs.AOPP ~/Chombo/lib/mk/Make.defs.local</div></div><!-- fragment --></li>
<li>Add the following to your ~/.login script (note this is for csh/tcsh shells, if you're using a bash shell then you'll need to use <a href="https://web.fe.up.pt/~jmcruz/etc/unix/sh-vs-csh.html">different commands</a> to set the environmental variables). <div class="fragment"><div class="line">module load chombo/3.2__hdf5v18</div><div class="line">setenv CH_TIMER &quot;true&quot;</div></div><!-- fragment --> And to your .bashrc <div class="fragment"><div class="line">setenv CHOMBO_HOME /path/to/Chombo/</div></div><!-- fragment --></li>
<li>Logout and log back in.</li>
<li><b>10 minutes</b>. Go to the Chombo code and start compiling <div class="fragment"><div class="line">$ cd $CHOMBO_HOME/lib/</div><div class="line">$ make lib</div></div><!-- fragment --> Technically you should now build and run all the test problems, but if you're feeling lucky you can skip straight to step 7. <div class="fragment"><div class="line">$ make test</div><div class="line">$ make run | grep &#39;finished with&#39;</div></div><!-- fragment --> Everything test should report 'finished with status 0'</li>
<li><b>5 minutes</b>. Build and run one of the released examples as a test <div class="fragment"><div class="line">$ cd $CHOMBO_HOME/releasedExamples/AMRGodunov/execAdvectDiffuse/</div><div class="line">$ make all</div><div class="line">$ ./amrGodunov2d.Linux.64.mpiCC.gfortran.OPT.MPI.ex diffuse.inputs </div></div><!-- fragment --> The output files produced are most easily opened using the <a href="https://wci.llnl.gov/simulation/computer-codes/visit">Visit software</a>, which is not currently installed on the AOPP servers (though it may be soon - I have asked for it).</li>
</ol>
<h2>Running code on AOPP servers</h2>
<p>There is an example SLURM batch script in <code>execSubcycle/slurmExample</code>. There is a batch script for building all the mushy layer code (with the relevant module dependencies) in <code>execSubcycle/buildMushyLayer.sh</code>, which can be modified for your needs.</p>
<h2>Time saving tips for AOPP</h2>
<ol type="1">
<li><b>Automating tasks on login</b>. After logging in to the machine where you run code from (e.g. atmlxmaster), add commands to your ~/.login file so you don't have to run them manually each time you login, e.g. <div class="fragment"><div class="line">module load visit/2.13.2 # gives you access to the visit command, which will let you visualise hdf5 files</div><div class="line">module load hdf5/1.8.18v18__parallel # load hdf5 for data I/O</div><div class="line">module load chombo/3.2__hdf5v18 # load chombo (though you may find it easier to just compile your own copy locally)</div><div class="line"></div><div class="line"># Set default squeue format to display longer job names</div><div class="line">setenv SQUEUE_FORMAT &quot;%.18i %.9P %.25j %.8u %.2t %.10M %.6D %.20R&quot;</div><div class="line"></div><div class="line"># Make sure we produce time.table files in chombo</div><div class="line">setenv CH_TIMER &quot;true&quot;</div></div><!-- fragment --></li>
<li><b>Mounting remote drives</b>. (Currently only tested on linux machines). You can mount remote drives like shared storage or your home directory over SSH, so that you can access them from your default file browser. On your local computer, first create a blank directory into which you will mount the drive, e.g. <div class="fragment"><div class="line">$ cd ~</div><div class="line">$ mkdir mnt</div><div class="line">$ cd mnt</div><div class="line">$ mkdir shared_storage</div></div><!-- fragment --> Now setup an SSH alias to tunnel through the gateway server, by adding the following (change your username!) to <code>~/.ssh/config</code> (create the file if it doesn't already exist): <div class="fragment"><div class="line">Host atmlxmaster</div><div class="line">User          parkinsonj</div><div class="line">HostName      atmlxmaster</div><div class="line">ProxyCommand  ssh parkinsonj@ssh-gateway.physics.ox.ac.uk nc %h %p %r 2&gt; /dev/null</div></div><!-- fragment --> then run the command (change your shared storage folder unless you want to mount mine!) <div class="fragment"><div class="line">$ sshfs -o idmap=user atmlxmaster:/network/group/aopp/oceans/AW002_PARKINSON_MUSH ~/mnt/shared_storage</div></div><!-- fragment --> you will be prompted for your SSH password (possibly twice). Thereafter you can access all your files from your local machine by going to <div class="fragment"><div class="line">cd ~/mnt/shared_storage</div></div><!-- fragment --> You can also mount your home drive in the same way i.e. <div class="fragment"><div class="line">$ sshfs -o idmap=user atmlxmaster:/home/parkinsonj/  ~/mnt/home</div></div><!-- fragment --> </li>
</ol>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Dec 28 2019 17:43:36 for Mushy Layer by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
